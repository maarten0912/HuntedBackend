<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hunted</title>
    <!-- Socket.io -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"
            integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA=="
            crossorigin="anonymous"></script>
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
          integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
            integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
            crossorigin=""></script>
    <!-- Moment -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"
            integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        body {
            margin: 0;
        }

        main {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #map {
            flex-grow: 1;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
<main>
<header>
    <h1>Hunted{% if current_user.is_admin() %} ADMIN{% endif %}</h1>
    <h2 class="hidden">Laatste update: <span id="last_update">00:00</span> geleden</h2>
</header>
    <div id="map"></div>
</main>
<script>
    const greenIcon = L.icon({
        iconUrl: 'https://leafletjs.com/examples/custom-icons/leaf-red.png',

        iconSize: [38, 95], // size of the icon
        shadowSize: [50, 64], // size of the shadow
        iconAnchor: [22, 94], // point of the icon which will correspond to marker's location
        shadowAnchor: [4, 62],  // the same for the shadow
        popupAnchor: [-3, -76] // point from which the popup should open relative to the iconAnchor
    });


    // Draw the map
    const map = L.map('map').setView([52.22, 6.89], 14)

    {# TODO restrict mapbox access token to url #}
    L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 18,
        id: 'mapbox/streets-v11',
        tileSize: 512,
        zoomOffset: -1,
        accessToken: 'pk.eyJ1IjoiZGF2dm9zMTEiLCJhIjoiY2t6aDV4eDJ6MTZ6bDJwbnJtd3o2dTg5YyJ9.X6wNGp1VG0Zkr3xUwHYNeg'
    }).addTo(map);

    const markers = {}

    const setMarker = (id, lat, long, hunter) => {
        // If this marker was already added, move it
        if (markers.hasOwnProperty(id)) {
            markers[id].setLatLng([lat, long])
        } else {
            let marker;
            if (hunter) {
                marker = L.marker([lat, long], {icon: greenIcon}).addTo(map)
            } else {
                marker = L.marker([lat, long]).addTo(map)
            }

            markers[id] = marker
        }
    }

    const updateLocations = (locations, json = false) => {
        for (let location of locations) {
            if (json)
                location = JSON.parse(location)
            console.log(location)
            // TODO, first (non-websocket) location has different id, fix in backend
            setMarker(location.id, location.lat, location.long, location.hunter)
        }
    }

    // Get the last positions
    fetch("/api/locations").then(async res => {
        const locations = (await res.json())["locations"]
        console.log(locations)
        updateLocations(locations)
    })

    // Get the last update time
    let last_update = Date.now()
    fetch("/api/last_update").then(async res => {
        last_update = await res.text()
    })

    // Connect to the websocket
    const socket = io.connect("/")

    socket.on("locations", locs => updateLocations(locs, true))
    socket.on("last_update", timestamp => last_update = timestamp)

    const zeroPad = (number) => {
        if (number < 10) {
            return "0" + number
        } else {
            return number
        }
    }

    // Update the time since the last update
    setInterval(() => {
        const diff = moment.duration(moment().diff(moment(last_update)))
        if (!diff._isValid) {
            return
        }
        const minutes = zeroPad(Math.floor(diff.asMinutes()))
        const seconds = zeroPad(Math.floor(diff.asSeconds() % 60))
        document.getElementById("last_update").innerText =
            `${minutes}:${seconds}`
        document.getElementById("last_update").parentElement.classList.remove("hidden")
    }, 1000)
</script>
</body>
</html>